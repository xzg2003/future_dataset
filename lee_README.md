# Welcome

[TOC]

这里是李亦凡的分支。用于分享、存储李亦凡的代码。

## lee.md文档说明

该md文档用于说明我的分支中的各个内容，记录我在每个任务中的**结果**、**问题**与**反思**。

## LEEyf分支说明

文件的存储、以及代码相应的规范要求，参考小组的任务要求。

为了避免数据集的传入，同时尽量减少对公共仓库的更改，我在本地设置了两个工作区，一个用于传输github文件，另一个完全镜像，用于我个人的代码编写与数据计算。

### .vscode文件夹

内部是settings.json文件，主要是工作区环境设置。同时在工作区内添加了部分词语的字典，避免系统拼写查错。

### factor_cal文件夹

因子计算文件，内部包括几个因子的.py计算文件，并通过类的封装全部集成在**factor_cal.py**，供程序调用。

#### 普通因子

各种因子如下（按字母名称排序）：

|           因子名称           |                             说明                             |
| :--------------------------: | :----------------------------------------------------------: |
|         FCT_Ac_Tr_1          |                  技术指标AC除以MA(TR)去量纲                  |
|           FCT_Ar_1           |          人气意愿指标，high、open、low差值累加对比           |
|          FCT_Bias_1          |                      乖离率除以Tr去量纲                      |
|           FCT_Br_1           |       人气意愿指标high, ref(close, 1), low差值累加对比       |
|          FCT_Cmf_1           | 资金流量指标，若收盘价在上半部分，且成交量放大，表示做多积极 |
|          FCT_Pubu_1          | 普及率因子，由短期均线和长期均线两条均线组成，衡量短期均线在长期均线窗口内的分位数位置 |
|      FCT_Pubu_Atr_Dfive      | 衡量短期均线在长期均线窗口内的分位数位置，并用 ATR 归一化，适合捕捉价格分布于波动率的关系 |
|      FCT_Pubu_Vol_Dfive      | 衡量短期均线在长期均线窗口内的分位数位置，并用成交量归一化，适合捕捉价格分布与成交活跃度的关系 |
|        FCT_R_Div_RStd        | 收益率与波动率比值因子，衡量单位波动下的收益率（动量/风险调整） |
|     FCT_Return_Cumsum_1      |        累积收益率因子，衡量从起始到当前的累积对数收益        |
|          FCT_Rsi_1           |                         相对强弱指标                         |
|          FCT_Sdrm_1          |        标准动量差因子，衡量收盘价在指定窗口内的波动性        |
|      FCT_Sdrm_Atr_Dfive      |  标准差动量与 ATR 归一化因子，衡量价格波动性与波动率的关系   |
|            FCT_Si            |     SI（波动率指标）因子，衡量收盘价的绝对变化幅度的均值     |
|           FCT_Srmi           | SRMI（相对动量指数）因子，衡量收盘价在指定窗口内的相对强弱位置 |
|   FCT_Support_Close_Thr_1    | 收盘价接近支撑位的次数因子，衡量收盘价在窗口内低于一定分位数的次数 |
| FCT_Support_Close_Thr_Boll_1 | 收盘价接近布林带下轨的次数因子，衡量收盘价在窗口内低于下轨的次数 |
|          FCT_Tsi_1           |                   TSI（趋势强度指标）因子                    |
|      FCT_Tsi_Atr_Dfive       |     趋势强度与 ATR 归一化因子，衡量单位波动下的趋势强度      |
|        FCT_TSI_Ref_1         |    TSI（真实强度指标）参考因子，衡量价格趋势的强弱和方向     |
|      FCT_Tsi_Vol_Dfive       |    趋势强度与成交量归一化因子，衡量单位成交量下的趋势强度    |
|          FCT_Vmacd           |       成交量 MACD 因子，衡量成交量的趋势变化和动能拐点       |
|     FCT_Vol_Close_Corr_1     | 成交量与收盘价相关系数因子，衡量指定窗口内成交量与收盘价的相关性 |
|       FCT_Vol_Cumsum_1       |         成交量累计因子，衡量从起始到当前的累计成交量         |
|       FCT_Vol_DFive_1        | 成交量动量因子，衡量成交量在指定窗口内的变化幅度（如标准差或均值） |
|    FCT_Vol_Return_Corr_1     | 成交量与收益率相关系数因子，衡量指定窗口内成交量与收益率的相关性 |
|            FCT_Vr            |    量比因子，衡量当前成交量与过去一段时间平均成交量的比值    |
|              Tr              | 波动幅度，当前k线的高低点与上根k线收盘价三者两两做差取绝对值最大的作为Tr波幅 |

#### 动量因子

动量因子反映了资产价格在一定时期内的延续性趋势。其基本原理是基于市场的非有效性，即资产价格不会立即对新信息做出充分反应，而是存在一定的滞后性。因此，在一段时间内，价格上涨（或下跌）的资产往往会继续保持上涨（或下跌）的趋势，这种趋势的强度和持续性就是动量因子所试图捕捉的。

|        动量因子名称        |                            说明                            |
| :------------------------: | :--------------------------------------------------------: |
|     时间序列动量TSMOM      |         用于衡量资产在过去一段时间内的累积收益情况         |
|      横截面动量XSMOM       | 通过比较同一时间点上不同资产的历史收益率，来预测其未来表现 |
|    加速因子Acceleration    |           用于衡量期货价格趋势强度和持续性的指标           |
| 日内动量 Intraday Momentem |              用于衡量一个交易日内价格变动趋势              |
|      相对强弱指标 RSI      |  用于衡量资产价格的相对强弱强度，来判断市场买卖力量的强弱  |

|   因子名称   |                   说明                    |
| :----------: | :---------------------------------------: |
| 简单截面动量 |            过去 K 天累积收益率            |
|   稳健动量   | 过去 K 天界面收益率排序后的标准化得分均值 |
|   趋势系数   |     简单动量基础上充分考虑路程的不同      |
|   日内动量   |           过去 K 天日内涨幅均值           |
|   隔夜动量   |           过去 K 天隔夜跳空均值           |
| RSI 动量因子 |   过去 K 天累积涨幅与累积绝对涨跌幅比值   |
|    乖离率    |              过去 K 天乖离率              |



### graphic

- graphic.py：图像绘制文件，利用计算得到的数据绘制图表。
- merge.py：因子合并文件，用于将不同期货类型中的同种因子合并在一个csv文件下。

### data(仅本地)

保存计算相关的数据。

- 5m：存储5分钟线的数据
- merge：存储不同期货品种的相同因子的合并数据集。
- mindiff：存储每个期货品种的最小变动单位。

## 更新日志

### 2025-04-10：期货数据集的搭建与因子计算

#### 2025-04-14

- 尝试通过ricequant下载数据集，但由于相关问题，我本地的数据集构建并没有成功。
- 后面处理所用的数据集都是直接利用子栩学长提供的数据包进行操作的。

#### 2025-04-15

- **基础学习内容**：学习了python中的类、类的封装等概念，并完善了字典等数据类型的理解。
- **进阶学习内容**：学习了pandas中对于数据处理的相关函数，包括：对csv文件的操作，滑动平均计算等内容。
- **任务处理成果**：按照量化小组的任务文档，成功实现了六个因子的计算，并成功在main.py文件下跑通了整个程序。所有的期货类型都实现了处理，程序处理总时间为20分钟左右，总数据文件大小为4Gb。
- **本周任务小结**:对数据处理有了初步地了解，但是由于学习跳跃程度较大，仍有很多内容无法完全掌握，后期需要继续补足。
- **存在的问题**：在所给的数据包中，没有找到mindiff(期货品种的最小变动单位)这个变量，因此，相关的函数直接输出结果，而没有进行相应的判断。正确的函数参考注释部分。
- 学习内容来源主要参考B站上的python学习视频，同时利用了copilot和豆包这两个ai进行程序设计上的辅助。

#### 2025-04-16

- **修改内容**：调整了Tr因子的计算方法，删除了内部冗余的计算步骤，简化算法、
- 补充了相关的注释，使程序的可读性更强。
- 同时完成因子数据分布图的绘制

#### 2025-04-18 	**Task_1_1.0.1**

- **增加内容1**：增加了graphic文件夹用于绘制因子相关图像。但是目前只做了一个函数，还没有像factor_cal文件那样利用类对这些函数进行封装。
- **增加内容2**：增加了image文件夹，用于存储相关图像。

#### 2025-04-19 	**Task_1_1.0.2**

- **增加内容1**：在graphic文件夹下增加了merge.py文件，用于将在不同期货类型中的同种因子合并在一个csv文件下面。
- **增加内容2**：为了存储这个合并的csv文件，在data文件夹下，新增了一个./merge/5m/路径，用于存储合并后的csv文件，得到的csv文件命名为{factor}@{length}.csv。
- 最后利用graphic绘制图像
- **后续工作**：目前的merge和graphic文件都没有利用循环对所有因子、所有长度进行计算，如有需要，下一步工作将把这个函数封装为一个类，并将所有因子的图像绘制出来。

#### 2025-04-23 	**Task_1_1.0.3**

周常会议之后，根据子栩学长建议做出了优化。

- **因子计算器的优化**：在先前的计算器中，计算出来的因子名称为"{factor}"而不包含任何滑动长度的信息。这次更新将得到的结果改为正确的"{factor}@{length}"的形式。
- **传参的优化**：在先前的factor_calculator程序将带有length和不带length的因子计算分开处理，导致代码十分冗长。这次更新，优化了字典的传参，利用param传入length，以实现factor.formula(param)传参的统一，两种情况的重复代码也归并为同一种，仅保留因文件命名不同导致不同的代码部分。
- **后续工作**：现有的代码仍然没有考虑mindiff的问题，这次会议之后下载了mindiff的数据包，但是来不及对相关代码进行修改。后续将针对这一部分进行处理。

#### 2025-05-01	**Task_1_1.0.4**

根据之前存在的问题进行了相应的改动

- **加入mindiff参数**：根据之前会议的讨论结果，在这次的更新中，更新了关于mindiff（最小变动单位）的读入、比较与使用。进而完善了因子计算器，得到的结果也更加完整。具体的调用流程为：在 main 中读取 mindiff.csv 文件、设置字典、因子计算器计算。
- **优化计算器**：在先前的计算器中，每次都要重新计算一次滑动平均，大大增加了计算量。在此次更新中，通过修改计算逻辑，减少了相关的计算量。同时，修改了存储的时间格式，改为存储datetime

```python
# TR 的滚动均值并处理 NaN
rolling_mean_tr = df['Tr'].rolling(window=length).mean().fillna(0)

# 计算收盘价的滚动均值
rolling_mean_close = df['close'].rolling(window=length).mean().fillna(0)

# 打印调试信息
print(f"rolling_mean_tr: {rolling_mean_tr}")
print(f"rolling_mean_close: {rolling_mean_close}")

# 使用 numpy.where 进行分类处理
df[f'FCT_Bias_1@{length}'] = numpy.where(
 	rolling_mean_tr < mindiff,
	0,
	(df['close'] - rolling_mean_close) / rolling_mean_tr
 )
```

- 优化了 main.py 中的循环逻辑，简化了循环代码段，并利用判断语句，为循环提供出口，减少程序的计算量
- 增加各处的报错信息，便于查错

#### 2025-05-10	**Task_2_1.0.5**

- 修改 lee_README.md 文档，增加因子说明部分
- **算法优化**：先计算 Tr 因子，后续的因子里，当需要调用 Tr 因子的时候，可以直接读取 Tr.csv 文件来计算。可以简化运算。

### 2025-05-07：期货因子计算进阶

#### 2025-05-11	**Task_2_1.0.6**

- 增加因子计算器 TSMOM
- 增加因子计算器 XSMOM。存在以下问题没有解决：
  1. 根据网上查到的资料，横截面动量因子的命名是 CSMOM，是否需要替换？这里直接用学长给的图示进行计算。
  2. 网上查到的资料没有详细解释这个因子应该怎样进行计算。这个因子似乎需要做多做空后进行回测。这里没有进行回测计算的条件，因此没有做相关的计算。
  3. 关于窗口动量因子，需要一种期货类型的不同期货进行计算。我们所用的数据是主力合约，因此这里的计算严格讲是不严谨的。
- 增加因子计算器 Acceleration
- 增加因子计算器 IDMOM。原文给的名称是"Intraday Momentem"，这里为了与 TSMOM 和 XSMOM统一，编写程序时简写成了IDMOM，后入如果有规范，可以进行相应修改
- 增加因子计算器 RSI

目前只是完成了因子计算器的算法部分，还没有进行具体的调试。后续会逐步进行调试。新编写的因子计算器也没有放进 factor_cal 总计算器中，在后续调试的时候逐个放入。

#### 2025-05-13	**Task_2_1.0.7**

- 增加因子计算器 RobustMOM，稳健动量。这里缺乏命名格式，暂时命名为 RobustMOM。
- 增加因子计算器 TrendStrength，趋势系数。这里缺乏命名格式，暂时命名为 TrendStrength
- 增加因子计算器 IntradayMOM，日内动量。这里缺乏命名格式，暂时命名为 IntradayMOM
- 增加因子计算器 Overnight，隔夜动量因子。这里缺乏命名格式，暂时命名为 Overnight
- 增加因子计算器 Bias，乖离率因子。这里缺乏命名格式，暂时命名为 Bias

#### 2025-05-16	**Task_2_1.0.8**

- **因子计算器**

  - 增加因子计算器 FCT_Pubu_1，普及率因子。由于没有短期均线和长期均线的定义，保存文件的命名格式也没有标准。

  - 增加因子计算器 FCT_Pubu_Atr_Dfive，利用 ATR 归一化的普及率因子。由于没有短期均线、长期均线和ATR窗口的定义，保存文件的命名格式也没有标准。

  - 增加因子计算器 FCT_Pubu_Vol_Dfive，利用 Vol 归一化的普及率因子。由于没有短期均线、长期均线和Vol窗口的定义，保存文件的命名格式也没有标准。

  - 增加因子计算器 FCT_R_Div_RStd，收益率与波动率比值因子。这里应该可以直接利用  FCT_Return_Cumsum_1 的计算结果进行计算。

  - 增加因子计算器 FCT_Return_Cumsum_1，累积收益率因子。

  - 增加因子计算器 FCT_Rsi_1，相对强弱指标。在之前的更新中已经更新了 RSI 的因子计算器，因此这里没有具体编写 FCT_Rsi_1 因子计算器。

  - 增加因子计算器 FCT_Sdrm_Atr_Dfive，标准动量差与 ATR 归一化因子。

- **问题：**在今天更新的一系列因子计算器中可以看出，很多计算器需要调用 ATR 计算的结果，部分也需要先前 Tr 的计算结果。在后续的调试中，可以将这些内容归并在一起计算。
- **增加的内容：**
  - 在 lee_README.md （即本文）中增加了一个待办模块。程序编写、会议中提到的各种问题都被记录在这个小节中。
  - 补充部分因子说明
  
#### 2025-05-17

-   **因子计算器：**
  - 增加因子计算器 FCT_Sdrm_1，标准动量差因子。
  - 增加因子计算器 FCT_Si，SI（波动率指标）因子。
  - 增加因子计算器 FCT_Srmi，SRMI（相对动量指数）因子。
  - 增加因子计算器 FCT_Support_Close_Thr_1，收盘价接近支撑位的次数因子。目前缺乏 thr 这一比例，暂定为0.3
  - 增加因子计算器 FCT_Support_Close_Thr_Boll_1，收盘价接近布林带下轨的次数因子。目前缺乏 n_std 这一布林带标准差倍数，暂定为2
  - 增加因子计算器 FCT_Tsi_1，TSI（趋势强度指标）因子。缺少 long 和 short
  - 增加因子计算器 FCT_Vmacd，成交量 MACD 因子。缺少 fast，slow，signal 长度。

#### 2025-05-19	**Task_2_1.0.9**

- **因子计算器**
  - 增加因子计算器 FCT_Tsi_Atr_Dfive，趋势强度与ATR归一化因子。目前缺乏 short 和 long 的定义，无法完全完成计算。同时，计算器中可以调用 ATR 的计算结果进行计算，后续可以进行优化。
  - 增加因子计算器 FCT_TSI_Ref_1，TSI（真实强度指标）参考因子。目前缺乏 short 和 long 的定义，无法完全完成计算。同时，计算器中可以调用 EMA、TSI 的计算结果。
  - 增加因子计算器 FCT_Tsi_Vol_Dfive，趋势强度与成交量归一化因子。目前缺乏 short 和 long 的定义，无法完全完成计算。同时，计算器中可以调用 EMA、TSI 的计算结果。
  - 增加因子计算器 FCT_Vol_Close_Corr_1，成交量与收盘价相关系数因子。
  - 增加因子计算器 FCT_Vol_Cumsum_1，成交量累计因子。
  - 增加因子计算器 FCT_Vol_DFive_1，成交量动量因子。
  - 增加因子计算器 FCT_Vol_Return_Corr_1，成交量与收益率相关系数因子。
  - 增加因子计算器 FCT_Vr，量比因子。

## 待办

- 2025-05-16
  - [ ] 时间窗口
    - [ ] 更新的计算器中缺少长期均线、短期均线和ATR窗口长度的定义，目前使用默认窗口长度进行计算，后续需要进行补全
    - [ ] 因子计算器的命名需要格式化，目前的命名暂定为"factor@{short}_{long}"
  - [ ] 部分因子的计算可以调用其他因子已计算得到的结果进行计算，简化代码
- 2025-05-17
  - [ ] FCT_Support_Close_Thr_1 因子计算器中，缺少 thr 比例.
  - [ ] FCT_Support_Close_Thr_Boll_1 因子计算器中，缺少 n_std
  - [ ] FCT_Tsi_1 因子计算器中，缺少 long 和 short
- 2025-05-19
  - [ ] FCT_Tsi_Atr_Dfive 因子计算器中，缺少 long 和 short。
  - [ ] FCT_Tsi_Atr_Dfive 因子计算器中，可以调用 ATR 的计算结果进行优化
  - [ ] FCT_TSI_Ref_1 因子计算器中，缺少 long 和 short
  - [ ] FCT_TSI_Ref_1 因子计算器中，可以调用 TSI 的计算结果
  - [ ] FCT_Tsi_Vol_Dfive 因子计算器中，缺少 long 和 short
  - [ ] FCT_Tsi_Vol_Dfive 因子计算器中，可以调用 TSI 的计算结果
  - [ ] FCT_Vmacd 因子计算器中，缺少 fast、slow、signal 几个长度。


